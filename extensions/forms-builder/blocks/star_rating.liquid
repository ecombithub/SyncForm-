<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css">

<div class="form_builder_app {{ block.id }}">
  <div style="background-size: cover;" id="formData-{{ block.id }}"></div>
</div>

<script>
  function toggleDropdown(event, fieldName) {
    event.preventDefault();

    const dropdown = document.getElementById(`dropdown-${fieldName}`);
    const selectBox = dropdown.previousElementSibling;
    const arrowSpan = selectBox.querySelector('span:last-child');

    const isVisible = dropdown.style.display === 'block';
    dropdown.style.display = isVisible ? 'none' : 'block';
    arrowSpan.textContent = isVisible ? '▼' : '▲';
  }

  document.addEventListener('click', function (event) {
    const selectContainers = document.querySelectorAll('.custom-select-container');

    selectContainers.forEach((container) => {
      if (!container.contains(event.target)) {
        const dropdown = container.querySelector('.custom-select-dropdown');
        if (dropdown) {
          dropdown.style.display = 'none';

          const selectBox = container.querySelector('.custom-select-box');
          const arrowSpan = selectBox.querySelector('span:last-child');
          arrowSpan.textContent = '▼';
        }
      }
    });
  });

  function filterOptions(event, fieldName) {
    const searchInput = event.target.value.toLowerCase();
    const optionsContainer = document.querySelector(`#dropdown-${fieldName} .options-container`);
    const options = optionsContainer.querySelectorAll('.custom-select-option');

    options.forEach((option) => {
      const text = option.textContent.toLowerCase();
      option.style.display = text.includes(searchInput) ? 'block' : 'none';
    });
  }

  document.addEventListener('click', function (event) {
    if (event.target.classList.contains('custom-select-option')) {
      const selectedValue = event.target.getAttribute('data-value');
      const selectedLabel = event.target.textContent;

      const selectBox = event.target
        .closest('.custom-select-container')
        .querySelector('.custom-select-box span:first-child');
      selectBox.textContent = selectedLabel;

      const dropdown = event.target.closest('.custom-select-dropdown');
      dropdown.style.display = 'none';

      const arrowSpan = selectBox.nextElementSibling;
      arrowSpan.textContent = '▼';

      console.log('Selected Value:', selectedValue);
    }
  });

  var handleClickImages = (fileInputId) => {
    const fileInput = document.getElementById(fileInputId);
    fileInput.click();
  };

  function handleDragOverimages(event) {
    event.preventDefault(); 
    event.stopPropagation();
  }
 
  
  function handleSingleInputChange(event, fieldId, fieldLabel) {
    const files = event.target.files;
    console.log('Files from file input:', files); 
    displayimagesNames(files, fieldId, fieldLabel);
  }
  
  function handleDropimages(event, fieldId, fieldLabel) {
    event.preventDefault();
    event.stopPropagation();
    console.log('Field Label:', fieldLabel);

    console.log('Field ID:', fieldId);
  
    const fileInput = document.getElementById(`file-input-${fieldId}`);
    console.log('File input element:', fileInput);
  
    if (!fileInput) {
      console.error('File input not found for fieldId:', fieldId);
      return;
    }
  
    const files = event.dataTransfer.files;
  
    displayimagesNames(files, fieldId,fieldLabel);
  }
  
  var uploadeImages = {}; 
  
  function displayimagesNames(files, fieldId, fieldLabel) {
    let fileNamesList = document.getElementById(`file-names-list-${fieldId}`);
    
    if (!fileNamesList) {
      console.log(`Element with id "file-names-list-${fieldId}" not found. Creating it.`);
      const formBuilderContainer = document.querySelector(`#file-input-${fieldId}`).closest('.form-builder-chaneging-wrap');
      if (formBuilderContainer) {
        const ul = document.createElement('ul');
        ul.id = `file-names-list-${fieldId}`;
        formBuilderContainer.appendChild(ul);
        fileNamesList = ul;
      }
    }

    fileNamesList.innerHTML = ''; 

    if (!uploadeImages[fieldId]) {
      uploadeImages[fieldId] = [];
    }

    console.log(`Field Label: ${fieldLabel} (Field ID: ${fieldId}) - Uploading files:`);

    Array.from(files).forEach((file) => {
      if (uploadeImages[fieldId].some(existingFile => existingFile.name === file.name)) {
        console.warn(`File "${file.name}" already added. Skipping.`);
        return;
      }

      const li = document.createElement('li');
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.alignItems = 'center';

      const fileName = document.createElement('span');
      fileName.textContent = file.name;
      fileName.style.flex = '1';

      const removeButton = document.createElement('button');
      removeButton.style.padding = '0';
      removeButton.style.border = 'none';
      removeButton.style.background = 'none';

      const reader = new FileReader();
      reader.onload = function (e) {
        const imagePreview = document.createElement('img');
        imagePreview.style.maxWidth = '100px';
        imagePreview.style.maxHeight = '100px';

        uploadeImages[fieldId].push({
          name: file.name,
          base64: e.target.result,
          label: fieldLabel
        });

        removeButton.onclick = () => {
          removeFile(file.name, fieldId, fileNamesList, li);
        };

        li.appendChild(fileName);
        li.appendChild(imagePreview);  
        li.appendChild(removeButton);
        fileNamesList.appendChild(li);
      };

      reader.readAsDataURL(file);

      console.log(`Field Label: ${fieldLabel} - Added file: ${file.name}`);
    });

    console.log('Final Uploaded Files:', uploadeImages);
}

 
  function handleClickmulti(fileInputId) {
    const fileInput = document.getElementById(fileInputId);
    fileInput.click();
  }

 function handleDragOverfile(event) {
  event.preventDefault(); 
  event.stopPropagation();
}

 var droppedMulti = []; 

function handleMultiInputChange(event, fieldId) {
  const files = event.target.files;
  console.log('Files from file input:', files); 
  displayFileNames(files, fieldId);
}

function handleDropfile(event, fieldId, fieldLabel) {
  event.preventDefault();
  event.stopPropagation();

  console.log('Field ID:', fieldId);

  const fileInput = document.getElementById(`file-input-${fieldId}`);
  console.log('File input element:', fileInput);

  if (!fileInput) {
    console.error('File input not found for fieldId:', fieldId);
    return;
  }

  const files = event.dataTransfer.files;

  displayFileNames(files, fieldId,fieldLabel);
}

var uploadedmulti = {}; 

function displayFileNames(files, fieldId, fieldLabel) {
  const fileNamesList = document.getElementById(`file-names-list-${fieldId}`);
  
  if (!fileNamesList) {
    console.log(`Element with id "file-names-list-${fieldId}" not found. Creating it.`);
    const formBuilderContainer = document.querySelector(`#file-input-${fieldId}`).closest('.form-builder-chaneging-wrap');
    if (formBuilderContainer) {
      const ul = document.createElement('ul');
      ul.id = `file-names-list-${fieldId}`;
      formBuilderContainer.appendChild(ul);
      fileNamesList = ul;
    }
  }

  fileNamesList.innerHTML = ''; 
  console.log('File list cleared. Creating new file list.');

  if (!uploadedmulti[fieldId]) {
    uploadedmulti[fieldId] = [];
    console.log(`No files for fieldId: ${fieldId}, initializing empty array.`);
  }

  console.log('Files received:', files);

  Array.from(files).forEach((file) => {
    const li = document.createElement('li');
    li.style.border = '1px solid #ddd';
    li.style.padding = '8px';
    li.style.marginBottom = '5px';
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';

    const fileName = document.createElement('span');
    fileName.textContent = file.name;
    fileName.style.flex = '1';

    const removeButton = document.createElement('button');
    removeButton.style.padding = '0';
    removeButton.style.border = 'none';
    removeButton.style.background = 'none';

    const removeImage = document.createElement('img');
    removeImage.src = 'https://cdn.shopify.com/s/files/1/0780/6255/1355/files/cancle1_1.png?v=1738132508';
    removeImage.alt = 'Remove';
    removeImage.style.width = '20px';
    removeImage.style.height = '20px';
    removeImage.style.cursor = 'pointer';

    removeButton.appendChild(removeImage);

    const reader = new FileReader();
    reader.onload = function (e) {
      console.log('Image preview loaded:', e.target.result);

      const imagePreview = document.createElement('img');
      imagePreview.style.maxWidth = '100px';
      imagePreview.style.maxHeight = '100px';
      // imagePreview.src = e.target.result; // Uncomment this if you want to show the image preview

      uploadedmulti[fieldId].push({
        name: file.name,
        base64: e.target.result,
        Label:fieldLabel
      });

      console.log('Added file to uploadedmulti:', uploadedmulti);

      removeButton.onclick = () => {
        console.log('Removing file:', file.name);
        removeFil1e(file.name, fieldId, fileNamesList, li);
      };

      li.appendChild(fileName);
      li.appendChild(imagePreview);  
      li.appendChild(removeButton);
      fileNamesList.appendChild(li);
    };

    reader.readAsDataURL(file);
  });

  console.log('Final Uploaded Files:', uploadedmulti);
}

function removeFil1e(fileName, fieldId, fileNamesList, li) {
  console.log(`Attempting to remove file: ${fileName} from fieldId: ${fieldId}`);

  if (!uploadedmulti[fieldId]) {
    console.log(`No files found for fieldId: ${fieldId}`);
    return;
  }

  console.log('Uploadedmulti before removal:', uploadedmulti);

  uploadedmulti[fieldId] = uploadedmulti[fieldId].filter(file => file.name !== fileName);

  console.log('Uploadedmulti after removal:', uploadedmulti);

  fileNamesList.removeChild(li);
  console.log('File list updated, item removed from DOM.');
}

  function handleDragOver(event) {
    event.preventDefault(); 
    event.stopPropagation();
  }
  
   var droppedFiles = []; 


   function handleFileInputChange(event, fieldId) {
    const files = event.target.files;
    console.log('Files from file input:', files); 
    displayimage(files, fieldId);
  }
  
function handleDrop(event, fieldId,fieldLabel) {
  event.preventDefault();
  event.stopPropagation();
  console.log('field Label:', fieldLabel);
  console.log('Field ID:', fieldId);

  const fileInput = document.getElementById(`file-input-${fieldId}`);
  console.log('File input element:', fileInput);

  if (!fileInput) {
    console.error('File input not found for fieldId:', fieldId);
    return;
  }

  const files = event.dataTransfer.files;

  displayimage(files, fieldId,fieldLabel);
}

var uploadedFiles = {}; 
function displayimage(files, fieldId,fieldLabel) {
  const fileNamesList = document.getElementById(`image-names-list-${fieldId}`);
  fileNamesList.innerHTML = ''; 

  if (!uploadedFiles[fieldId]) {
    uploadedFiles[fieldId] = [];
  }

  console.log('Files received:', files); 

  Array.from(files).forEach((file) => {
    const li = document.createElement('li');
    li.style.border = '1px solid #ddd';
    li.style.padding = '8px';
    li.style.marginBottom = '5px';
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';

    const fileName = document.createElement('span');
    fileName.textContent = file.name;
    fileName.style.flex = '1';

    const removeButton = document.createElement('button');
    removeButton.style.padding = '0';
    removeButton.style.border = 'none';
    removeButton.style.background = 'none';

    const removeImage = document.createElement('img');
    removeImage.src = 'https://cdn.shopify.com/s/files/1/0780/6255/1355/files/cancle1_1.png?v=1738132508';
    removeImage.alt = 'Remove';
    removeImage.style.width = '20px';
    removeImage.style.height = '20px';
    removeImage.style.cursor = 'pointer';

    removeButton.appendChild(removeImage);

    const reader = new FileReader();
    reader.onload = function (e) {
      console.log('Image preview loaded:', e.target.result);
      
      const imagePreview = document.createElement('img');
      imagePreview.style.maxWidth = '100px'; 
      imagePreview.style.maxHeight = '100px';
      {% comment %} imagePreview.src = e.target.result; {% endcomment %}

      uploadedFiles[fieldId].push({
        name: file.name,
        base64: e.target.result,
        label: fieldLabel
      });

      removeButton.onclick = () => removeFile(file.name, fieldId, fileNamesList, li);

      li.appendChild(fileName);
      li.appendChild(imagePreview);
      li.appendChild(removeButton);
      fileNamesList.appendChild(li);
    };

    reader.readAsDataURL(file);
  });

  console.log('Uploaded Files:', uploadedFiles);
}

function removeFile(fileName, fieldId, fileNamesList, li) {
  if (!uploadedFiles[fieldId]) return;
  uploadedFiles[fieldId] = uploadedFiles[fieldId].filter(file => file.name !== fileName);
  fileNamesList.removeChild(li);
  console.log('Updated Uploaded Files:', uploadedFiles);
}


  $(document).ready(function () {
    const formId = '{{ block.settings.formId }}';
    console.log('Form ID:', formId);

    if (formId && formId !== 'default-id') {
      fetchFormData(formId);
    }

    function fetchFormData(id) {
      $('#formData-{{ block.id }}').empty();

      $.ajax({
        url: `https://hubsyntax.online/get-form/${id}`,
        method: 'GET',
        success: function (data) {
          console.log('Fetched form data:', data);

          if (data.status === 'draft') {
            $('#formData-{{ block.id }}').append('<p>Form is in draft  and cannot be displayed.</p>');
            return;
          }

          displayFormData(data);
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error('Error: ' + errorThrown);
          $('#formData-{{ block.id }}').append('<p></p>');
        },
      });
    }

    function displayFormData(formData) {
      const container = $('#formData-{{ block.id }}');
      const formTitle = formData.title || 'Form Data';
      const formID = formData.formId || 'Unknown ID';
      const formshop = formData.shop || 'Form shop';
      const toggleStatus = formData.toggleStatus || 'toggleStatus';

      console.log('Formshop:', formshop);
      container.empty();

      if (formData.styles) {
        console.log('Form styles:', formData.styles);

        const backgroundOverlay = $('<div class="background-overlay"></div>');
        backgroundOverlay.css({
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundSize: 'cover',
          backgroundColor: formData.styles.backgroundColor || '',
          backgroundImage: formData.styles.backgroundImage ? `url(${formData.styles.backgroundImage})` : 'none',
          backgroundRepeat: formData.styles.backgroundRepeat || 'no-repeat',
          opacity: formData.styles.opacityForm || 1,
          borderColor: formData.styles.borderColor || '',
          borderWidth: formData.styles.borderWidth || '',
          borderStyle: formData.styles.borderStyle || '',
          borderRadius: formData.styles.borderRadius ? `${formData.styles.borderRadius}px` : '',
          zIndex: -1,
        });

        container.append(backgroundOverlay);

        container.css({
          position: 'relative',
          width: formData.styles.width || '100%',
          padding: formData.styles.padding || '20px',
          margin: 'auto',
        });
      }
      container.append(`<h2 style="display:none">${formshop}</h2>`);
      container.append(`<h2 style="display:none">${formTitle}</h2>`);
      container.append(`<h2 style="display:none">${toggleStatus}</h2>`);
      container.append(`<p style="display:none"><strong>Form ID:</strong> ${formID}</p>`);

      if (formData.fields && formData.fields.length > 0) {
        formData.fields.forEach((field) => {
          const floatStyle =
            (field.type === 'text' ||
              field.type === 'name' ||
              field.type === 'email' ||
              field.type === 'slider' ||
              field.type === 'number' ||
              field.type === 'file' ||
              field.type === 'phone ' ||
              field.type === 'datetime' ||
              field.type === 'location' ||
              field.type === 'multi-file' ||
              field.type === 'multi-image' ||
              field.type === 'password' ||
              field.type === 'images' ||
              field.type === 'select' ||
              field.type === 'radio' ||
              field.type === 'checkbox' ||
              field.type === 'textarea' ||
              field.type === 'date' ||
              field.type === 'time' ||
              field.type === 'url') &&
            (parseFloat(field.width) <= 50 ||
              parseFloat(field.width) === 25 ||
              parseFloat(field.width) === 50 ||
              parseFloat(field.width) === 75)
              ? 'float: inline-start;'
              : '';
          const inputGap = formData.styles.inputGap || '0px';
          const labelColor = formData.styles.labelColor || '#000';
          const inputRadius = formData.styles.inputRadious;
          const inputBorderColor = formData.styles.inputborderColor;
          const inputBgColor = formData.styles.inputBgColor;
          const inputStyle = formData.styles.inputstyle;
          const inputWidth = formData.styles.inputwidth;
          const headingcolor = formData.styles.colorHeading;
          const headingaline = formData.styles.textHeading;
          const emailsubject = formData.styles.subject;
          const maxDescriptionHeight = formData.styles.maxDescriptionHeight;
               
          const fieldHtml = `
                  <div key="${field.id}" style= "width: ${
            field.width
          }; ${floatStyle} margin-bottom: ${inputGap}px;"class="${`input-field ${field.customClass} input-gap ${
            parseFloat(field.width) <= 50 ? 'small-width' : ''
          }`}">
                      ${
                        field.type !== 'heading' &&
                        field.type !== 'description' &&
                        field.type !== 'button' &&
                        field.type !== 'link' &&
                        field.type !== 'divider'
                          ? `<label style="color: ${labelColor};">${field.label}</label>`
                          : ''
                      }
                      
                     ${getFieldInput(
                       field,
                       formData.url,
                       formData.submissionOption,
                       formData.thankYouTimer,
                       formData.editorValue,
                       formshop,
                       formTitle,
                       toggleStatus,
                       inputRadius,
                       inputBorderColor,
                       inputBgColor,
                       inputStyle,
                       inputWidth,
                       headingcolor,
                       headingaline,
                       emailsubject,
                       maxDescriptionHeight
                     )}
                  </div>
                  `;
          container.append(fieldHtml);
        });

        $('.input-gap').css({
          padding: '5px',
          display: 'flow-root',
        });

        $('.iti').css('width', '100%');

        $('label').css('display', 'block');
      } else {
        container.append('<p>No fields available.</p>');
      }
      container.append('<div class="clear-float"></div>');
    }

    window.validatePassword = function (input, minLength) {
      const passwordStatus = input.dataset.passwordStatus;
      const password = input.value;
      const errorMessage = input.nextElementSibling;

      let isValid = password.length >= minLength;
      let errorText = `Password must be at least ${minLength} characters long.`;

      if (passwordStatus === 'on') {
        const hasNumber = /\d/.test(password);
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasNumber || !hasSpecialChar) {
          isValid = false;
          errorText = `Password must be at least ${minLength} characters long, include at least one number, and one special character.`;
        }
      }
      errorMessage.textContent = errorText;
      errorMessage.style.display = isValid ? 'none' : 'block';
    };
    function getFieldInput(
      field,
      formUrl,
      submissionOption,
      thankYouTimer,
      editorValue,
      formshop,
      formTitle,
      toggleStatus,
      inputRadius,
      inputBorderColor,
      inputBgColor,
      inputStyle,
      inputWidth,
      headingcolor,
      headingaline,
      emailsubject,
      maxDescriptionHeight
    ) {
      const uniqueId = field.id || generateUniqueId();

      switch (field.type) {
        case 'name':
          return `<input type="text" placeholder="${
            field.placeholder || ''
          }" style="width: 100%; padding: ${field.inputPadding}; border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} " aria-label="${field.label || 'Name'}" /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div> `;
        case 'text':
          return `<input type="text" placeholder="${
            field.placeholder || ''
          }" style="width: ${field.width || '100%'};padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} " aria-label="${field.label || 'Text Input'}" /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'toggle':
          return `
            <label style="display: inline-block; position: relative; width: 50px; height: 24px;">
              <input 
                type="checkbox" 
                style="display: none;" 
                aria-label="${field.label || 'Toggle'}" 
                 onchange="this.nextElementSibling.style.backgroundColor = this.checked ? '#45A7F6' : '#cccccc'; 
                  this.nextElementSibling.nextElementSibling.style.transform = this.checked ? 'translateX(26px)' : 'translateX(0)'; 
                  togglevalue = this.checked ? '${field.onValue}' : '${field.offValue}';
                   console.log('Toggle Value:', togglevalue); "
              />
             
              <span style="
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #cccccc;
                transition: 0.4s;
                border-radius: 24px;
              "></span>
              <span style="
                position: absolute;
                content: '';
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: 0.4s;
                border-radius: 50%;
                transform: translateX(0);
              "></span>
            </label> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description || ''}</div>`;

        case 'textarea':
          return `<textarea placeholder="${
            field.placeholder || ''
          }" name="w3review" rows="4" cols="50" style="width: ${field.width || '100%'};padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} " aria-label="${field.label || 'Textarea'}">
          <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
          </textarea>`;
        case 'checkbox':
          return `
                <div style="width: ${
                  field.width || '100%'
                };padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} ">
                  ${field.options
                    .map(
                      (option) => `
                   <div class="form_checkbox_flex" style="display: flex; gap: 10px; align-items: center; padding: 10px;">
                      <input type="checkbox" id="${option.id}" name="${field.name}" value="${option.value}" ${
                        field.required ? 'required' : ''
                      } ${field.readonly ? 'readonly' : ''}/>
                      <label for="${option.id}">${option.label}</label>
                    </div>
                  `
                    )
                    .join('')}
                </div>
                 <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
              `;
        case 'radio':
          return `
                  <div style="width: ${
                    field.width || '100%'
                  };padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} ">
                  ${field.options
                    .map(
                      (option) => `
                    <div class="form_radio_flex" style="display: flex; gap: 10px; align-items: center; padding: 10px;">
                      <input type="radio" id="${option.id}" name="${field.name}" value="${option.value}" ${
                        option.checked ? 'checked' : ''
                      } aria-label="${field.label || 'Radio Input'}"/>
                      <label for="${option.id}">${option.label}</label>
                    </div>
                  `
                    )
                    .join('')}
                </div>
                  <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
              `;
        case 'select':
          const options = field.options
            .map((option) => `<div class="custom-select-option" data-value="${option.value}">${option.label}</div>`)
            .join('');

          return `
                <div class="custom-select-container" style="position: relative;">
                  <div class="custom-select-box" style="width: ${
                    field.width || 'auto'
                  }; padding: ${field.inputPadding}; border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color :${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle}; cursor: pointer;" onclick="toggleDropdown(event, '${field.name}')">
                    <span>${field.label || 'Select Input'}</span><span style = "float: right">▼</span>
                  </div>
                  <div id="dropdown-${
                    field.name
                  }" class="custom-select-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; border: 1px solid ${inputBorderColor || '#ccc'}; background-color: #fff; padding: 5px; z-index: 100;">
                    <input
                      type="text"
                      id="search-${field.name}"
                      placeholder="Search..."
                      style="width: 100%; padding: 5px; margin-bottom: 5px; border-radius: ${
                        inputRadius || '4px'
                      }; border: 1px solid #ccc;"
                      oninput="filterOptions(event, '${field.name}')"
                    />
                    <div class="options-container" style = "cursor : "pointer"">
                      ${options}
                    </div>
                  </div>
                </div>
                 <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
              `;
        case 'divider':
          return `<hr style="border: 1px solid ${field.dividerColor}; width: 100%;" /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'description':
          return `<p style="font-size: ${field.textSize || '16px'}px; 
                  color: ${field.textColor || '#000'}; 
                  line-height:${field.textlineheight}px;
                  text-align: ${field.textAline || 'center'};">
                  ${field.text || 'Default description'}
                  </p>`;
        case 'heading':
          let fontSize = '';
          if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(field.level)) {
            switch (field.level) {
              case 'h1':
                fontSize = `${field.fontSize || 40}px`;
                break;
              case 'h2':
                fontSize = `${field.fontSize || 36}px`;
                break;
              case 'h3':
                fontSize = `${field.fontSize || 30}px`;
                break;
              case 'h4':
                fontSize = `${field.fontSize || 26}px`;
                break;
              case 'h5':
                fontSize = `${field.fontSize || 23}px`;
                break;
              case 'h6':
                fontSize = `${field.fontSize || 19}px`;
                break;
            }
          }
          return `<${field.level} style="font-size: ${fontSize}; 
                          color: ${headingcolor || '#000'}; 
                          text-align: ${headingaline || 'center'};">
                          ${field.text || 'Default Heading'}
                          </${field.level}>`;

        case 'number':
          return `<input type="text" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="${
            field.placeholder || ''
          }" style="width: ${field.width || '100%'}; padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} "  " /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'file':
          let fileInputHTML = '';

          if (field.fileOptions[field.id] === 'option1') {
            fileInputHTML = `
              <input type="file" placeholder="${field.placeholder || ''}" 
                style="width: ${field.width || '100%'}; padding: ${
              field.inputPadding
            }; border-radius: ${inputRadius}px; 
                border-color: ${inputBorderColor}; background-color: ${inputBgColor}; border-width: ${inputWidth}px; 
                border-style: ${inputStyle}" onchange="handleSingleInputChange(event, '${field.id}', '${field.label}')" /> 
              <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          } else if (field.fileOptions[field.id] === 'option2') {
            fileInputHTML = `
            <div class="drag-and-drop-text third" style="text-align: center;">
                <div class='form-builder-chaneging-wrap file' style="border-radius:10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding: 30px;" 
                onclick="handleClickImages('file-input-${field.id}')"
                ondragover="handleDragOverimages(event)"
                  ondrop="handleDropimages(event, '${field.id}', '${field.label}')">  
                 <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" onchange="handleSingleInputChange(event, '${field.id}', '${field.label}')" />
                  <div class='form-builder-changes-file-wraped'>
                    <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/singlefile.png?v=1739342645" alt="" style="display: inline;" />
                    <div class='email-files drop' style="margin-top: 10px;">
                      <p style="font-size: 15px; font-weight: 600;">Drag & Drop your files here</p>
                    </div>
                  </div>
                </div>
              </div>
          <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          } else if (field.fileOptions[field.id] === 'option3') {
            fileInputHTML = `
            <div class="drag-and-drop-text first" style="text-align: center;">
               <div class='form-builder-chaneging-wrap file' style="border-radius: 10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding:${field.width === '25%' ? '20px': '30px'};" 
               onclick="handleClickImages('file-input-${field.id}')"
               ondragover="handleDragOverimages(event)"
                ondrop="handleDropimages(event, '${field.id}', '${field.label}')">  
                 <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" onchange="handleSingleInputChange(event, '${field.id}, '${field.label}'')" />
             <div class="form-builder-changes-file-wraped" style="display: flex; gap: 10px; justify-content: center; align-items: center;">
              <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/1.png?v=1739342645" style="width: ${field.width === '25%' ? '50px' : 'auto'};" alt="" />
                 <div class="email-files drop" style="width: ${field.width === '25%' ? '100%' : 
                                               field.width === '50%' ? '100%' : 
                                               field.width === '75%' ? '38%' : 
                                               field.width === '100%' ? '26%' : 
                                               field.width || '60%'};">
                 <p style="font-size:${field.width === '25%' ? '11px': '15px'}; text-align: ${field.width === '25%' ? 'left': ''};">Drop Files Here or <span style="color: #00ac4f;">browse for files.</span></p>
                </div>
                 </div>
               </div>
           </div>
              
             <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          }
          return fileInputHTML;
          case 'multi-file':
          let multifileInputHTML = '';
          if (field.multiOptions[field.id] === 'option1') {
            multifileInputHTML = `
              <input type="file" placeholder="${field.placeholder || ''}" 
                style="width:100%; padding: ${
                  field.inputPadding
                }; border-radius: ${inputRadius}px; 
                border-color: ${inputBorderColor}; background-color: ${inputBgColor}; border-width: ${inputWidth}px; 
                border-style: ${inputStyle}" multiple onchange="handleMultiInputChange(event, '${field.id}')" /> 
             <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          } else if (field.multiOptions[field.id] === 'option2') {
            multifileInputHTML = `
              <div class="drag-and-drop-text first" style="text-align: center;">
                <div class="form-builder-chaneging-wrap file" style="border-radius:10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding:${field.width === '25%' ? '20px': '30px'};" 
                onclick="handleClickmulti('file-input-${field.id}')"
                 ondragover="handleDragOverfile(event)"
                 ondrop="handleDropfile(event, '${field.id}', '${field.label}')">
                  <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" multiple onchange="handleMultiInputChange(event, '${field.id}')" />
                  <div class="form-builder-changes-file-wraped">
                    <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/mut2.png?v=1739350278" alt="" style="display: inline;" />
                   <div className='email-files drop' style="margin-top: 20px; margin-bottom: 30px;">
                     <h2 style="font-weight: ${field.width === '25%' ? '500': '600px'}; font-size: ${field.width === '25%' ? '11px': '18px'};"> Drag & Drop <span style="color:#09ae54;">images,</span></h2>
                     <h2 style="font-weight: ${field.width === '25%' ? '500': '600px'}; font-size: ${field.width === '25%' ? '11px': '18px'};"><span style="color:#09ae54;">videos,</span> or any <span style="color:#09ae54;" >file</span></h2>
                     </div>
                    <span class="form-builder-changes-file-button" style="background: #00ac4f; border-radius: 31px;
                     padding: 5px 22px; font-size: ${field.width === '25%' ? '12px': '17px'};border: 0;color: white;display: inline-block;text-align: center;">
                    Upload
                       </span>

                  </div>
                </div>
              </div>
              <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          } else if (field.multiOptions[field.id] === 'option3') {
            multifileInputHTML = `
                <div class="drag-and-drop-text third" style="text-align: center;">
        <div class="form-builder-chaneging-wrap file" style="border-radius:10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding:${field.width === '25%' ? '20px': '30px'};"
          onclick="handleClickmulti('file-input-${field.id}')"
        ondragover="handleDragOverfile(event)"
        ondrop="handleDropfile(event, '${field.id}', '${field.label}')">
        <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" multiple onchange="handleMultiInputChange(event, '${field.id}')"/>
          <div class="form-builder-changes-file-wraped">
        <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/multifile.png?v=1739350277" alt="" style="display: inline;" />
        <div className='email-files drop' style="margin-top: 20px;">
          <h3 style="color: #404b52;font-weight: bold; font-size: ${field.width === '25%' ? '11px': '19px'}; line-height: ${field.width === '25%' ? '16px': '40px'};">Drag & drop files or <span style="color: #79c27c; text-decoration: underline;">Browse</span></h3>
          <p style="color: #676767; font-size: ${field.width === '25%' ? '11px': '15px'}; max-width: ${field.width === '25%' ? '100%': '53%'}; margin: auto; 
             line-height: ${field.width === '25%' ? '16px': '23px'}; margin-bottom: 40px; font-weight: 550;">
            Supported formats: JPEG, PNG, GIF, MP4, PDF, PSD, AI, Word, PPT
          </p>
          <span style="background: #4fae52; color: white !important; padding: ${field.width === '25%' ? '10px 20px': '10px 70px'}; 
             border-radius: 4px; border: 1px solid #209324;font-size: ${field.width === '25%' ? '12px': '14px'};">
             Upload files
          </span>
        </div>
         </div>
         </div>
      </div>
              <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          }
          return `
        
            <div style="display: flex; flex-direction: column;">
              ${multifileInputHTML}
              
              <ul id="file-names-list-${field.id}" style="margin-top: 8px;"></ul>
              ${field.description ? `<span style="margin-top: 8px;">${field.description}</span>` : ''}
            </div>
          `;
        
        case 'email':
          return `<input type="email" placeholder="${
            field.placeholder || ''
          }" style="width: 100%; padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} "  " />  <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'phone':
          const phoneInputHtml = `
          <input type="tel" id="phone-${uniqueId}" placeholder="${field.placeholder || ''}" 
            style="width: ${field.width || '100%'}; 
                   padding: ${field.inputPadding || '10px'}; 
                   border-radius: ${inputRadius || '4px'}px; 
                   border-color: ${inputBorderColor || '#ccc'}; 
                   background-color: ${inputBgColor || '#fff'}; 
                   border-width: ${inputWidth || '1'}px; 
                   padding-left:50px;
                  border-style: ${inputStyle || 'solid'};"
      inputmode="tel" pattern="[0-9]*" />
          <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
        `;
          setTimeout(() => {
            const phoneInput = document.querySelector(`#phone-${uniqueId}`);
            if (phoneInput) {
              const iti = window.intlTelInput(phoneInput, {
                initialCountry: 'us',
                utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js',
              });

              iti.setCountry('us');
              $('.iti').css('width', '100%');

              phoneInput.addEventListener('input', () => {
                phoneInput.value = phoneInput.value.replace(/[^0-9]/g, '');
                const phoneNumber = iti.getNumber();
                console.log('Formatted phone number: ', phoneNumber);
              });
            }
          }, 100);
          return phoneInputHtml;
        case 'password':
          return `
            <div style="position: relative;">
              <input type="password" placeholder="${field.placeholder || ''}" 
                style="width: ${field.width || '100%'}; padding: ${field.inputPadding};
                border-radius: ${inputRadius}px; border-color: ${inputBorderColor};
                background-color: ${inputBgColor}; border-width: ${inputWidth}px;
                border-style: ${inputStyle}" 
                data-password-status="${field.passwordStatus}" 
                oninput="validatePassword(this, ${field.passwordCharacter || 6})"
              />
              <small style="color: red; display: none;"></small>
            </div>
           <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
          `;

        case 'url':
          return `<input type="url" placeholder="${
            field.placeholder || ''
          }" style="width: ${field.width || '100%'}; padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} "  " /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div> `;
        case 'location':
          return `<input type="text" placeholder="${
            field.placeholder || ''
          }" style="width: ${field.width || '100%'}; padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} "  " /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'date':
          return `<input type="date" placeholder="${
            field.placeholder || ''
          }" style="width: ${field.width || '100%'}; padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} "  " /><div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'datetime':
          return `<input type="datetime-local" placeholder="${
            field.placeholder || ''
          }" style="width: ${field.width || '100%'}; padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} "  " /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'time':
          return `<input type="time" placeholder="${
            field.placeholder || ''
          }" style="width: ${field.width || '100%'}; padding: ${field.inputPadding};border-radius: ${inputRadius}px; border-color: ${inputBorderColor}; background-color:${inputBgColor}; border-width:${inputWidth}px; border-style:${inputStyle} "  " /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'link':
          return `
        <a
        href="${field.linkUrl || '#'}"
        target="${field.linkTarget || '_blank'}"
         style="
          width: ${field.width || '100%'};
          text-decoration: none;
          text-align: ${field.linkaline || 'left'};
          padding: ${field.padding || '0'};
          "
             >${field.linktext || 'Default Link Text'} <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div></a>
      `;
      case 'images':
      let imagesInputHTML = '';
      if (field.imageOptions[field.id] === 'option1') {
        imagesInputHTML = `
          <input type="file" placeholder="${field.placeholder || ''}" 
            style="width: 100%; padding: ${
          field.inputPadding
        }; border-radius: ${inputRadius}px; 
            border-color: ${inputBorderColor}; background-color: ${inputBgColor}; border-width: ${inputWidth}px; 
            border-style: ${inputStyle}" onchange="handleSingleInputChange(event, '${field.id}', '${field.label}')"/> 
          <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
        `;
      } else if (field.imageOptions[field.id] === 'option2') {
        imagesInputHTML = `
      
          <div class="drag-and-drop-text third" style="text-align: center;">
            <div class='form-builder-chaneging-wrap file' style="border-radius:10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding: 30px;" 
              onclick="handleClickImages('file-input-${field.id}')"
               ondragover="handleDragOverimages(event)"
              ondrop="handleDropimages(event, '${field.id}', '${field.label}')"> 
              <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" onchange="handleSingleInputChange(event, '${field.id}', '${field.label}')" />
              <div class='form-builder-changes-file-wraped'>
                <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/singleimage0.png?v=1739353222" alt="" style="display: inline;" />
                <div class='email-files drop' style="margin-top: 20px;">
                  <p style="font-size: 15px; font-weight: 600;">Drag & Drop your image here</p>
                </div>
              </div>
            </div>
          </div>
          <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
        `;
      } else if (field.imageOptions[field.id] === 'option3') {
        imagesInputHTML = `
        <div class="drag-and-drop-text first" style="text-align: center;">
          <div class="form-builder-chaneging-wrap file" 
        style="border-radius:10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding: ${field.width === '25%' ? '20px' : '30px'};" 
        onclick="handleClickImages('file-input-${field.id}')"
        ondragover="handleDragOverimages(event)"
        ondrop="handleDropimages(event, '${field.id}', '${field.label}')"> 
        <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" onchange="handleSingleInputChange(event, '${field.id}', '${field.label}')" />
         <div class="form-builder-changes-file-wraped" 
         style="display: flex; gap: ${field.width === '25%' ? '10px' : '50px'}; justify-content: center; align-items: center;">
            <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/singleimage1.png?v=1739353222" 
            alt="Upload" 
         style="width: ${field.width === '25%' ? '50px' : 'auto'};" />
         <div class="email-files drop" 
         style="width: ${field.width === '25%' ? '100%' : 
                       field.width === '50%' ? '100%' : 
                       field.width === '75%' ? '38%' : 
                       field.width === '100%' ? '26%' : 
                       field.width || '60%'};">
        
          <h2 style="text-align: ${field.width === '25%' ? 'left' : 'center'}; 
                   font-size: ${field.width === '25%' ? '11px' : '18px'}; 
                   font-weight: ${field.width === '25%' ? '500' : '600'};">
          Drop image Here or <span style="color: #00ac4f;">browse for image.</span>
          </h2>

        </div>
        </div>
        </div>
         </div>
          <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
        `;
      }
      return imagesInputHTML;

          case 'multi-image':
          let multiimageInputHTML = '';
          if (field.multiimagesOptions[field.id] === 'option1') {
            multiimageInputHTML = `
              <input type="file" placeholder="${field.placeholder || ''}" 
                style="width: 100%; padding: ${
                  field.inputPadding
                }; border-radius: ${inputRadius}px; 
                border-color: ${inputBorderColor}; background-color: ${inputBgColor}; border-width: ${inputWidth}px; 
                border-style: ${inputStyle}" multiple onchange="handleFileInputChange(event, '${field.id}')" /> 
              <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          } else if (field.multiimagesOptions[field.id] === 'option2') {
            multiimageInputHTML = `
              <div class="drag-and-drop-text first" style="text-align: center;">
                <div class="form-builder-chaneging-wrap file" style="border-radius:10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding: ${field.width === '25%' ? '20px' : '30px'};"
                 onclick="handleClickmulti('file-input-${field.id}')"
                 ondragover="handleDragOver(event)"
                 ondrop="handleDrop(event, '${field.id}','${field.label}')">
                  <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" multiple onchange="handleFileInputChange(event, '${field.id}')" />
                  <div class="form-builder-changes-file-wraped">
                    <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/multiimg1.png?v=1739355803" alt="" style="display: inline;" />
                   <div className='email-files drop' style="margin-top: 20px; margin-bottom: ${field.width === '25%' ? '0': '20px'};">
                     <h2 style="font-weight: 600; font-size: ${field.width === '25%' ? '16px': '18px'};">Drop your images here </h2>
                       <h2 style="font-weight: 500; font-size: 14px;"><span style="color:#9ed29f;">Browse file </span> from your computer</h2>
                     </div>
                  
                  </div>
                </div>
              </div>
              <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          } else if (field.multiimagesOptions[field.id] === 'option3') {
            multiimageInputHTML = `
              <div class="drag-and-drop-text third" style="text-align: center;">
             <div class="form-builder-chaneging-wrap file" style="border-radius:10px; border: 2px dashed #8ee2b4; margin: auto; justify-content: center; background: white; padding: ${field.width === '25%' ? '20px' : '30px'};"
         onclick="handleClickmulti('file-input-${field.id}')"
          ondragover="handleDragOver(event)"
          ondrop="handleDrop(event, '${field.id}','${field.label}')">
            <input type="file" accept="image/*" id="file-input-${field.id}" style="display: none;" multiple onchange="handleFileInputChange(event, '${field.id}')"/>
         <div class="form-builder-changes-file-wraped">
        <img src="https://cdn.shopify.com/s/files/1/0780/6255/1355/files/multiimg.png?v=1739355803" alt="" style="width: ${field.width === '25%' ? '50px' : 'auto'}; margin: ${field.width === '25%' ? 'auto' : 'auto'};" />
         <div className='email-files drop' style="margin-top: 20px;">
          <h3 style="color: #404b52;font-weight: 500; font-size: ${field.width === '25%' ? '16px' : '19px'}; margin-bottom: 30px; line-height: ${field.width === '25%' ? '16px' : '40px'};">
          Drag & Drop <span style="color : #00ac4f;">images,</span>
        </h3>
        <span class="form-builder-changes-file-button" style="background: #00ac4f; border-radius: 31px; padding: 5px 22px; font-size: ${field.width === '25%' ? '16px' : '17px'}; border: 0;color: white;display: inline-block;text-align: center;">
          Upload
        </span>
         </div>
       </div>
          </div>
         </div>

              <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>
            `;
          }
          return `
            <div style="display: flex; flex-direction: column;">
              ${multiimageInputHTML}
              <ul id="image-names-list-${field.id}" style="margin-top: 8px;"></ul>
              ${field.description ? `<span style="margin-top: 8px;">${field.description}</span>` : ''}
            </div>
          `;

        case 'slider':
          return `<input 
                    type="range" 
                    placeholder="${field.placeholder || ''}" 
                    style="width: ${field.width || '100%'};" 
                    min="${field.min}" 
                    max="${field.max}" 
                    step="${field.step}" 
                    /> <div class="description" style="min-height: ${maxDescriptionHeight}px;">${field.description}</div>`;
        case 'button':
          return `
              <div style= "text-align:${field.buttonaline}">
                <button
                  style="background-color: ${
                    field.backgroundColor || '#007bff'
                  }; height: ${field.buttonHeight || '40px'}; 
                    min-width: ${field.btnwidth}px;
                    font-size: ${field.buttontext}px;
                    padding: ${field.padding}px;
                    border-width: ${field.buttonBorderWidth}px;
                    border-style: ${field.buttonBorderStyle || 'solid'};
                    border-color: ${field.buttonBorderColor || '#000'};
                    border-radius: ${field.btnradious}px;
                    color:${field.btncolor}"
                    data-url="${formUrl}"
                    onclick="submitFormData('{{ block.id }}', this, '${
                      editorValue || ''
                    }', '${submissionOption || ''}', '${thankYouTimer || ''}', '${formshop}','${formTitle}', '${toggleStatus}','${emailsubject}')">
                  ${field.label || 'Submit'}
                </button>
              </div>
            `;

        default:
          return '';
      }
    }

    function generateUniqueId() {
      return Math.random().toString(36).substr(2, 9);
    }

    const currentTimestamp = new Date().toISOString();
    window.submitFormData = function (
      blockId,
      button,
      editorValue,
      submissionOption,
      thankYouTimer,
      formshop,
      formTitle,
      toggleStatus,
      emailsubject
    ) {
      const container = $('#formData-' + blockId);
      const formID = container.find('p').first().text().split(': ')[1];
      console.log('Editor Value:', editorValue);
      console.log('Submission Option:', submissionOption);
      console.log('Thank You Timer:', thankYouTimer);
      console.log('form_id:', formID);
      console.log('formshop:', formshop);
      console.log('toggleStatus:', toggleStatus);
      console.log('email-subject', emailsubject);
      console.log('images-all',uploadeImages);
      console.log('images',uploadedFiles);
      console.log('uploaded-multi',uploadedmulti);

      const formData = {
        id: formID,
        shop: formshop || 'defaultShopName',
        title:formTitle || 'defaultTitle',
        fields: [],
        send: currentTimestamp,
        url: $(button).data('url') || '',
        editorValue: editorValue,
        thankYouTimer: thankYouTimer,
      };

      if (toggleStatus === 'Enabled') {
        console.log('Window URL:', window.location.href);
        formData.currentUrl = window.location.href;
      } else if (toggleStatus === 'Disabled') {
        console.log('Form submission is disabled');
      }
      
      const emailField = $('#formData-' + blockId + ' input[type="email"]');
      if (emailField.length === 0) {
          formData.email = 'no email';  
      } else {
          formData.email = emailField.val() || 'no email'; 
      }
      let isValid = true;
      let uploadedFileNames = new Set();
      let uniqueImageFileNames = new Set(); 
      let uniqueImageImagesNames = new Set(); 
      $('#formData-' + blockId + ' .input-field').each(function () {
        const fieldName = $(this).find('label').text().trim();
        const input = $(this).find('input, select, textarea');
        const dropdown = $(this).find('.custom-select-box span:first-child');
        const fieldId = input.attr('id') || generateUniqueId();
        let fieldValue;
        let imagesFieldExists = false;  
        let allFileNames = [];
        let multiFileNames = [];
        let uniqueFileNames = []; 
        if (dropdown.length > 0) {
          fieldValue = dropdown.text().trim();
        } else if (input.is(':radio')) {
          fieldValue = $('input[name="' + input.attr('name') + '"]:checked').val();
        } else if (input.is(':checkbox')) {
          fieldValue = [];
          $(this)
            .find('input[type="checkbox"]:checked')
            .each(function () {
              fieldValue.push($(this).val());
            });
          fieldValue = fieldValue.join(', ');
        } else if (input.attr('type') === 'file') {
          fieldValue = [];
          
          if (uploadeImages && typeof uploadeImages === 'object') {
            Object.keys(uploadeImages).forEach((key) => {
              uploadeImages[key].forEach((file) => {
      
                if (file.label === file.label) {
               
                  const isImageAlreadyAdded = formData.fields.some((field) => field.name === file.label && field.value === file.name);
                  
                  if (!uploadedFileNames.has(file.name) && !isImageAlreadyAdded) { 
                    uploadedFileNames.add(file.name);  
                    formData.fields.push({
                      id: generateUniqueId(),  
                      name: file.label, 
                      value: file.name,  
                      send: currentTimestamp  
                    });
                  }
                }
          
                if (file.label === file.label) {
                  const isFileAlreadyAdded = formData.fields.some((field) => field.name === file.label && field.value === file.name);
          
                  if (!uploadedFileNames.has(file.name) && !isFileAlreadyAdded) {  
                    uploadedFileNames.add(file.name);
                    formData.fields.push({
                      id: generateUniqueId(),  
                      name: file.label, 
                      value: file.name, 
                      send: currentTimestamp  
                    });
                  }
                }
              });
            });
          }
         
          if (uploadedFiles && typeof uploadedFiles === 'object') {
            Object.keys(uploadedFiles).forEach((key) => {
              uploadedFiles[key].forEach((file) => {
                if (!uploadedFileNames.has(file.name)) {
                  if (!uniqueImageFileNames.has(file.name)) { 
                    uniqueImageFileNames.add(file.name); 
                    allFileNames.push(file.name);
                  }
                } else {
                 
                  if (!uniqueImageFileNames.has(file.name)) {
                    uniqueImageFileNames.add(file.name);  
                    allFileNames.push(file.name);  
                  }
                }
              });
            });

            if (allFileNames.length > 0) {
              formData.fields.push({
                id: generateUniqueId(),  
                name: uploadedFiles[Object.keys(uploadedFiles)[0]][0].label,   
                value: allFileNames.join(', '),
                send: currentTimestamp
              });
            }
          }

          if (uploadedmulti && typeof uploadedmulti === 'object') {
            Object.keys(uploadedmulti).forEach((key) => {
                uploadedmulti[key].forEach((file) => {
                    if (file && file.name) {  
                        if (!uploadedFileNames.has(file.name)) {
                            if (!uniqueImageImagesNames.has(file.name)) { 
                                uniqueImageImagesNames.add(file.name); 
                                multiFileNames.push(file.name);
                            }
                        } else {
                            if (!uniqueImageImagesNames.has(file.name)) {
                                uniqueImageImagesNames.add(file.name);  
                                multiFileNames.push(file.name);  
                            }
                        }
                    }
                });
        
                if (multiFileNames.length > 0) {
                    formData.fields.push({
                        id: generateUniqueId(),  
                        name: uploadedmulti[key]?.[0]?.Label || 'Multi-file', 
                        value: multiFileNames.join(', '),
                        send: currentTimestamp
                    });
                }
            });
           }        

          fieldValue = fieldValue.join(', ');
          $(this).find('input[type="file"]').val('');
        } else {
          fieldValue = input.val();
        }
        
        if (fieldValue !== undefined && fieldValue.trim() !== '') {
          formData.fields.push({
            id: fieldId,
            name: fieldName,
            value: fieldValue,
            send: currentTimestamp,

          });
        }
      });

      if (!isValid) return;

      console.log('Form Data:', JSON.stringify(formData));

      $.ajax({
        url: 'https://hubsyntax.online/api/forms',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
          console.log('Form submitted successfully:', response);
          alert('Form submitted successfully!');
          $(this).find('ul').empty();
          const toggleInput = $('#formData-' + blockId + ' input[type="checkbox"]');
          toggleInput.prop('checked', false);
          toggleInput.next().css('backgroundColor', '#cccccc');
          toggleInput.next().next().css('transform', 'translateX(0)');

          $('#formData-' + blockId + ' .input-field input[type="file"]').val('');
          $('#formData-' + blockId + ' .input-field ul').empty();
          $('#formData-' + blockId + ' .input-field input[type="radio"]').prop('checked', false);
          $('#formData-' + blockId + ' .input-field input[type="checkbox"]').prop('checked', false);

          $('#formData-' + blockId + ' .custom-select-box span:first-child').text('Select an option');

          console.log('Form ID:', formData.id);

          console.log('Form ID:', formData.id);
          if (formData.id) {
            $.ajax({
              url: 'https://hubsyntax.online/get/data',
              method: 'GET',
              success: function (data) {
                console.log('Fetched data:', data);

                const matchingForm = data.data.find((form) => form.form_ids.includes(formData.id));

                if (matchingForm) {
                  console.log('Matched form data:', matchingForm);

                  $.ajax({
                    url: 'https://hubsyntax.online/api/template',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                      TemplateAll: matchingForm,
                      email: formData.email,
                      subject: emailsubject,
                    }),
                    success: function (templateResponse) {
                      console.log('Template data sent successfully:', templateResponse);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                      console.error('Error sending template data:', errorThrown);
                    },
                  });
                } else {
                  console.log('No matching form found for Form ID:', formData.id);
                }
              },
              error: function (jqXHR, textStatus, errorThrown) {
                console.error('Error fetching data:', {
                  textStatus: textStatus,
                  errorThrown: errorThrown,
                  responseText: jqXHR.responseText,
                });
              },
            });
          } else {
            console.log('Form ID is not available');
          }
          const formUrl = $(button).data('url');

          const successMessage = '<p id="success-message">Form submitted successfully!</p>';
          const successElement = $(successMessage);

          setTimeout(function () {
            $('#success-message').remove();
          }, 2000);

          if (editorValue) {
            const editorValueDisplay = `<p>${editorValue}</p>`;
            const messageElement = $(editorValueDisplay);
            $('#formData-' + blockId).append(messageElement);

            successElement.hide();
            $('#formData-' + blockId).append(successElement);

            setTimeout(function () {
              messageElement.remove();
            }, 3000);
          } else {
            $('#formData-' + blockId).append(successElement);

            setTimeout(function () {
              successElement.remove();
            }, 3000);
          }

          if (submissionOption === 'Hide form and show thank you message') {
            $(
              '#formData-' +
                blockId +
                ' .form, #formData-' +
                blockId +
                ' input, #formData-' +
                blockId +
                ' textarea, ' +
                '#formData-' +
                blockId +
                ' select, #formData-' +
                blockId +
                ' button, #formData-' +
                blockId +
                ' label, ' +
                '#formData-' +
                blockId +
                ' .custom-select-container, #formData-' +
                blockId +
                ' .custom-select-dropdown, ' +
                '#formData-' +
                blockId +
                ' h1, #formData-' +
                blockId +
                ' p'
            ).each(function () {
              console.log($(this));
              $(this).hide();
            });

            $('#formData-' + blockId).hide();

            const container = $('#formData-' + blockId);
            container.css({
              backgroundSize: 'cover',
              backgroundColor: formData.styles.backgroundColor || '',
              backgroundImage: formData.styles.backgroundImage ? `url(${formData.styles.backgroundImage})` : 'none',
              backgroundRepeat: formData.styles.backgroundRepeat || 'no-repeat',
              boxShadow: formData.styles.boxShadow || '',
              width: formData.styles.width || '100%',
              padding: formData.styles.padding || '20px',
              borderColor: formData.styles.borderColor || '',
              borderWidth: formData.styles.borderWidth || '',
              borderStyle: formData.styles.borderStyle || '',
              opacity: formData.styles.opacityForm || '',
              borderRadius: formData.styles.borderRadius ? `${formData.styles.borderRadius}px` : '',
              margin: 'auto',
            });
          } else if (thankYouTimer) {
            const timerDuration = parseInt(thankYouTimer) * 1000;
            setTimeout(() => {
              $('#formData-' + blockId + ' p').fadeOut();
            }, timerDuration);
          }

          if (formUrl && formUrl !== 'undefined') {
            window.open(formUrl);
          } else {
            console.log('No valid form URL provided.');
          }

          $(
            '#formData-' + blockId + ' input, #formData-' + blockId + ' textarea, #formData-' + blockId + ' select'
          ).val('');
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error('Error submitting form:', {
            textStatus: textStatus,
            errorThrown: errorThrown,
            responseText: jqXHR.responseText,
          });
          const errorMessage = '<p>Error submitting form. Please try again.</p>';
          const errorContainer = $('#formData-' + blockId);
          errorContainer.append(errorMessage);

          setTimeout(function () {
            errorContainer.find('p').fadeOut('slow', function () {
              $(this).remove();
            });
          }, 2000);
        },
      });
    };
  });
</script>

{% schema %}
{
  "name": "Form Submission",
  "target": "section",
  "settings": [
    { "type": "color", "id": "colour", "label": "Button Text Colour", "default": "#ff0000" },
    { "type": "color", "id": "bgcolour", "label": "Button Background Colour", "default": "#ff0000" },
    { "type": "text", "id": "formId", "label": "Form ID" }
  ]
}
{% endschema %}

